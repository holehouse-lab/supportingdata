# Readme
##### Last updated 2025-10-06

This directory houses the "aligned" scattering profiles as pickle files. These files were generated by some internal code that the Holehouse lab developed for "aligning" scattering data.

## How does this work?
We can back-calculate scattering data from ensembles using [foxs](https://modbase.compbio.ucsf.edu/foxs/download).

This gives us a `.dat` file which has three columns:

	q	I(q) signal	I(q) error
	
Our experimental scattering data has the same format. HOWEVER, the challenge is that the absolute values of I(q) data in experiment and simulation are _internally_ consistent but absolutely arbitray. As such, if we want to "compare" these two curves we have to 'align' them; that is figure out a scalar factor that converts the I(q) values for one to best match the I(q) of another. Further, the (q) values where we have I(q) data are likely not 1:1 between experiment and ensemble.

We get around this by doing the following:

1. Selecting a fitting region (typically between q=0.01 to q=0.25, so _most_ of the curve).
2. Extrapolating between points in the fitting region for the computationally-generated data (which is always smooth) so we can then have 1-to-1 comparisons between experimental and computational scattering data at the same q values
3. Find the scalar that minimizes the RMSE between the two curves
4. Use this scalar to rescale the entire curve


In this way, we "align" the two curves for easy comparison. Because this is all done using in-house code, we pre-computed these "aligned" curves and save them as pickle files so these can be replotted without requiring our backend infrastructure.

## Code snippet for plotting scattering data
For comparing scattering data between experiment and ensemble, we do the following:

	import pickle
	import matplotlib.pyplot as plt
	
	def read_pickle(fn):
	    """Reads a pickle file and returns the stored object."""
	    with open(fn, "rb") as f:
	        return pickle.load(f)
	
	# read  in the pickle files
	d = read_pickle(<pickle file name here>)
    
	# first extract out I0; we use this for normalization
	I0 = d[0]['D2_Iq'][0]
	
	# extract out experimental values
	q_vals_exp = d[0]['D1_q']
	normalized_Iq_exp = d[0]['D1_Iq']/I0
	normalized_Iq_exp_error = d[0]['D1_Iq_error']/I0
	    
	# plot experimental scattering with error
	plt.errorbar(q_vals_exp, q_vals_exp, yerr= normalized_Iq_exp_error, fmt='o', linewidth=0.2, markersize=0.5, color='k', mew=0.4, alpha=0.2)
    
	# extract out scattering data from ensemble	q_vals_ensemble = d[0]['D2_q']
	normalized_Iq_ensemble = d[0]['D2_Iq']/I0
	
	# plot ensemble scattering curve as a red line
	plt.plot(q_vals_ensemble, normalized_Iq_ensemble, '-', linewidth=0.35, markersize=0.5, color='r', zorder=10, mew=0.2, alpha=1)


## Pickle file structure
Each pickle file has the following structure:


	tuple of length 3 with three dictionaries. Dictionaries here function as simple labelled data structures that hold different sets of data 
	
    dictionary 1 - contains experimentally aligned scattering data, as well as the raw scattering data from the ensemble and experiment
	
    'D1_q'            : q values for data from experiment (file1, D1)
    'D2_q'            : q values for data from simulation (file2, D2)
	
    'D1_Iq'           : Scattering data from experiment - i.e. I(q)  data
    'D1_2q'           : Experiment-aligned scattering data from simulation
	
    'D1_Iq_error'     : Scattering data error from experiment - i.e. error on I(q)  
    'D2_Iq_error'     : Experiment-aligned scattering data error from simulation
	
    'D2_Iq_raw'       : Non-experiment-aligned scattering data from somulation
    'D2_Iq_error_raw' : Non-experiment-aligned scattering data error from simulation
	
	
    dictionary 2 - contains experimentally aligned scattering data all normalized by I0, such that at the limit of q->0 I(q) is 1.0
	
    'D1_q'                    : q values for data from experiment (file1, D1)
    'D2_q'                    : q values for data from simulation (file2, D2)
	
    'D1_Iq_over_I0'           : Scattering data from experiment - i.e. I(q) data, normalized by I0
    'D2_Iq_over_I0'           : Experiment-aligned scattering data from simulation, normalized by I0
 
    'D1_Iq_over_I0_error'     : Scattering data error from experiment - i.e. error on I(q), normalized by I0
    'D2_Iq_over_I0_error'     : Experiment-aligned scattering data error from simulation, normalized by I0
	
    'D2_Iq_over_I0_raw'       : Non-experiment-aligned scattering data from somulation
    'D2_Iq_over_I0_error_raw' : Non-experiment-aligned scattering data error from simulation
	
	
    dictionary 3 - contains experimentally aligned (in experimental I(q) units and I/I0 units) for JUST the subregions of the curve that were aligned. This is useful for checking how an alignment region alters the goodness of fit.
    
    'D1_q_fitting'           : q values for experimental scattering data over fitting region
    'D2_q_fitting'           : q values for simulated scattering data over fitting region
	
    'D1_Iq_fitting'          : I(q) scattering data for experimental data over fitting range
    'D2_Iq_fitting'          : I(q) scattering data from simulation for for experimentally 
                               aligned scattering data
	
    'D1_Iq_over_I0_fitting'  : I(q)/I0 for experimental scattering data over fitting region
    'D2_Iq_over_I0_fitting'  : I(q)/I0 for experimentally alugned  simulated scattering data over
                               fitting region
	
    'q_min_fitting'          : smallest fitting q value (float)
    'q_max_fitting'          : largest fitting q value (float)
